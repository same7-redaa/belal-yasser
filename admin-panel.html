<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><text x='50' y='70' font-size='60' font-weight='bold' text-anchor='middle' fill='%23fff' font-family='Arial, sans-serif'>B</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @font-face {
            font-family: 'Nahdi-Black';
            src: url('fonts/Nahdi-Black.woff2') format('woff2'),
                 url('fonts/Nahdi-Black.woff') format('woff'),
                 url('fonts/Nahdi-Black.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --bg-dark: #121212;
            --accent-orange: #FF5722;
            --text-light: #f5f5f5;
            --text-muted: #aaaaaa;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --font-primary: 'Nahdi-Black', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/liquid-blurry.png');
            opacity: 0.1;
            z-index: -1;
            pointer-events: none;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }

        .login-box h1 {
            color: var(--accent-orange);
            margin-bottom: 30px;
            text-align: center;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: var(--font-primary);
            margin-bottom: 20px;
            transition: border-color 0.3s;
            background: rgba(255, 255, 255, 0.9);
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--accent-orange);
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: var(--accent-orange);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-family: var(--font-primary);
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 20px rgba(255, 87, 34, 0.4);
        }

        .login-box button:hover {
            transform: translateY(-2px);
        }

        .error-message {
            color: #f44336;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px var(--shadow-color);
        }

        .header h1 {
            color: var(--accent-orange);
            font-size: 28px;
        }

        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-family: var(--font-primary);
            transition: transform 0.2s;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .card {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            color: var(--accent-orange);
            margin-bottom: 20px;
            font-size: 22px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-orange);
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group select option {
            background: #1a1a1a;
            color: var(--text-light);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: #f5f5f5;
            border: 2px dashed #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-input-label:hover {
            background: #e8eaf6;
        }

        .file-input-label i {
            margin-left: 10px;
            color: #667eea;
        }

        .selected-files {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-family: var(--font-primary);
            transition: all 0.3s ease;
            margin-left: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: var(--accent-orange);
            color: white;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Projects Table */
        .projects-table {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f5f5f5;
            color: #667eea;
            font-weight: 600;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .project-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: opacity 0.2s;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .edit-btn {
            background: #2196F3;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        .toggle-btn {
            background: #ff9800;
            color: white;
        }

        .checkbox-cell {
            text-align: center;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .new-category-input {
            display: none;
            margin-top: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: auto;
        }

        .modal-content {
            background-color: #1a1a1a;
            margin: 5% auto;
            padding: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .modal-header {
            padding: 20px 30px;
            background: var(--accent-orange);
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: white;
        }

        .close {
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .categories-manager {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .add-category-section h3,
        .existing-categories-section h3 {
            color: var(--accent-orange);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .categories-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .category-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-item.sub-category {
            margin-left: 30px;
            border-left: 3px solid var(--accent-orange);
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            color: var(--text-light);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .category-name-en {
            color: var(--text-muted);
            font-size: 14px;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .category-actions button {
            padding: 5px 10px;
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .categories-manager {
                grid-template-columns: 1fr;
            }
            
            .content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1><i class="fas fa-lock"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
            <input type="password" id="passwordInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
            <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
            <div class="error-message" id="loginError">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="header">
            <h1><i class="fas fa-tachometer-alt"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h1>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>

        <div class="content">
            <!-- Add Project Form -->
            <div class="card">
                <h2><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <form id="projectForm">
                    <div class="form-group">
                        <label>Ø§Ù„ÙØ¦Ø©:</label>
                        <select id="projectCategory" onchange="toggleNewCategory()">
                            <option value="">-- Ø§Ø®ØªØ± ÙØ¦Ø© --</option>
                            <option value="__new__">+ Ø¥Ù†Ø´Ø§Ø¡ ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>
                        </select>
                        <input type="text" id="newCategoryInput" class="new-category-input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¹Ø±Ø¨ÙŠ)">
                        <input type="text" id="newCategoryInputEn" class="new-category-input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (English)" style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label>Ø§Ù„ØµÙˆØ± (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø©):</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="projectImages" accept="image/*" multiple onchange="updateFileList()">
                            <label for="projectImages" class="file-input-label">
                                <i class="fas fa-cloud-upload-alt fa-2x"></i>
                                <span>Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ±</span>
                            </label>
                        </div>
                        <div class="selected-files" id="selectedFiles"></div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showOnHomepage" checked>
                            Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-upload"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                    </button>
                </form>
                <div class="status-message" id="statusMessage"></div>
            </div>

            <!-- Projects List -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;"><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
                    <button class="btn" onclick="openCategoriesManager()" style="background: var(--accent-orange);">
                        <i class="fas fa-folder"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª
                    </button>
                </div>
                
                <div class="bulk-actions">
                    <button class="btn btn-danger" onclick="bulkDelete()" id="bulkDeleteBtn" disabled>
                        <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
                    </button>
                    <button class="btn btn-warning" onclick="bulkToggleHomepage(true)" id="bulkShowBtn" disabled>
                        <i class="fas fa-eye"></i> Ø¥Ø¸Ù‡Ø§Ø± ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                    <button class="btn btn-warning" onclick="bulkToggleHomepage(false)" id="bulkHideBtn" disabled>
                        <i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                    <button class="btn btn-success" onclick="loadProjects()">
                        <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>

                <div class="projects-table">
                    <table id="projectsTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                                <th>Ø§Ù„ÙØ¦Ø©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr>
                                <td colspan="6" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories Manager Modal -->
    <div id="categoriesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-folder-tree"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</h2>
                <span class="close" onclick="closeCategoriesManager()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="categories-manager">
                    <div class="add-category-section">
                        <h3>Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                        <div class="form-group">
                            <label>ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©:</label>
                            <select id="parentCategorySelect">
                                <option value="">-- ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ Ø£Ø¨) --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© (Ø¹Ø±Ø¨ÙŠ):</label>
                            <input type="text" id="newCatNameAr" placeholder="Ù…Ø«Ø§Ù„: ØªØµÙ…ÙŠÙ… Ø´Ø¹Ø§Ø±Ø§Øª">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© (English):</label>
                            <input type="text" id="newCatNameEn" placeholder="Example: Logo Design">
                        </div>
                        <button class="btn btn-primary" onclick="addNewCategory()">
                            <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©
                        </button>
                    </div>
                    
                    <div class="existing-categories-section">
                        <h3>Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</h3>
                        <div id="categoriesList" class="categories-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://bkvcmceyxsgzvvcozwkf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdmNtY2V5eHNnenZ2Y296d2tmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMDAyODQsImV4cCI6MjA3NTY3NjI4NH0.TtZg_fT1gBCfxx7jT9bTk_ylm7kAjQGflCbMKcyZJWY';
        const BUCKET_NAME = 'portfolio-images';
        const ADMIN_PASSWORD = '010274';

        let supabase;
        let allProjects = [];
        let selectedProjects = new Set();

        // Initialize Supabase
        if (typeof window.supabase !== 'undefined') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Login
        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                sessionStorage.setItem('adminLoggedIn', 'true');
                loadCategories();
                loadProjects();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // Logout
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        }

        // Check if already logged in
        window.addEventListener('load', () => {
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadCategories();
                loadProjects();
            }
        });

        // Enter key for login
        document.getElementById('passwordInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

                // Load Categories
        async function loadCategories() {
            try {
                const { data: projects } = await supabase
                    .from('projects')
                    .select('category, category_en, parent_category');

                // Ø¥Ù†Ø´Ø§Ø¡ Map Ù„Ù„ÙØ¦Ø§Øª Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¦Ù‡Ø§ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
                const categoriesMap = new Map();
                projects.forEach(p => {
                    if (!categoriesMap.has(p.category)) {
                        categoriesMap.set(p.category, {
                            en: p.category_en || p.category,
                            parent: p.parent_category
                        });
                    }
                });
                
                const select = document.getElementById('projectCategory');
                select.innerHTML = '<option value="">-- Ø¥Ø®ØªØ± ÙØ¦Ø© --</option>';
                
                // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØ¦Ø§Øª: Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©
                const mainCategories = Array.from(categoriesMap.keys())
                    .filter(cat => !categoriesMap.get(cat).parent)
                    .sort();
                
                mainCategories.forEach(cat => {
                    const catData = categoriesMap.get(cat);
                    select.innerHTML += `<option value="${cat}" data-category-en="${catData.en}">ğŸ“ ${cat}</option>`;
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©
                    const subCategories = Array.from(categoriesMap.keys())
                        .filter(subCat => categoriesMap.get(subCat).parent === cat)
                        .sort();
                    
                    subCategories.forEach(subCat => {
                        const subData = categoriesMap.get(subCat);
                        select.innerHTML += `<option value="${subCat}" data-category-en="${subData.en}">   â†³ ${subCat}</option>`;
                    });
                });
                
                select.innerHTML += '<option value="__new__">+ Ø¥Ù†Ø´Ø§Ø¡ ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>';
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Toggle New Category Input
        function toggleNewCategory() {
            const select = document.getElementById('projectCategory');
            const input = document.getElementById('newCategoryInput');
            const inputEn = document.getElementById('newCategoryInputEn');
            
            if (select.value === '__new__') {
                input.style.display = 'block';
                inputEn.style.display = 'block';
                input.required = true;
                inputEn.required = true;
            } else {
                input.style.display = 'none';
                inputEn.style.display = 'none';
                input.required = false;
                inputEn.required = false;
            }
        }

        // Update File List
        function updateFileList() {
            const files = document.getElementById('projectImages').files;
            const display = document.getElementById('selectedFiles');
            
            if (files.length > 0) {
                display.textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${files.length} ØµÙˆØ±Ø©`;
            } else {
                display.textContent = '';
            }
        }

        // Compress Image Function
        function compressImage(file, maxWidth = 1920, maxHeight = 1920, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round((width * maxHeight) / height);
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    // Create a new file from the blob
                                    const compressedFile = new File([blob], file.name, {
                                        type: 'image/jpeg',
                                        lastModified: Date.now()
                                    });
                                    
                                    const originalSize = (file.size / 1024 / 1024).toFixed(2);
                                    const compressedSize = (blob.size / 1024 / 1024).toFixed(2);
                                    console.log(`âœ… Compressed: ${file.name} from ${originalSize}MB to ${compressedSize}MB`);
                                    
                                    resolve(compressedFile);
                                } else {
                                    reject(new Error('ÙØ´Ù„ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©'));
                                }
                            },
                            'image/jpeg',
                            quality
                        );
                    };
                    img.onerror = () => reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'));
                };
                reader.onerror = () => reject(new Error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
            });
        }

        // Add Project
        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const categorySelect = document.getElementById('projectCategory');
            let category = categorySelect.value;
            let categoryEn = '';
            const newCategory = document.getElementById('newCategoryInput').value;
            const newCategoryEn = document.getElementById('newCategoryInputEn').value;
            const images = document.getElementById('projectImages').files;
            const showOnHomepage = document.getElementById('showOnHomepage').checked;
            const submitBtn = document.getElementById('submitBtn');

            if (category === '__new__') {
                category = newCategory;
                categoryEn = newCategoryEn;
            } else {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ category_en Ù…Ù† Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
                const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                categoryEn = selectedOption.getAttribute('data-category-en') || category;
            }

            if (!category || images.length === 0) {
                showStatus('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø© ÙˆØ§Ù„ØµÙˆØ±', 'error');
                return;
            }

            submitBtn.disabled = true;
            showStatus('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±...', 'success');

            try {
                let successCount = 0;
                
                for (let i = 0; i < images.length; i++) {
                    const image = images[i];
                    
                    // Compress image before upload
                    showStatus(`Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ${i + 1} Ù…Ù† ${images.length}...`, 'success');
                    const compressedImage = await compressImage(image);
                    
                    const fileName = `${Date.now()}_${i}_${image.name.replace(/\.[^/.]+$/, '')}.jpg`;
                    
                    // Upload compressed image
                    showStatus(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1} Ù…Ù† ${images.length}...`, 'success');
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from(BUCKET_NAME)
                        .upload(fileName, compressedImage, {
                            cacheControl: '3600',
                            upsert: false,
                            contentType: 'image/jpeg'
                        });

                    if (uploadError) throw uploadError;

                    // Get public URL
                    const { data: publicUrlData } = supabase.storage
                        .from(BUCKET_NAME)
                        .getPublicUrl(uploadData.path);
                    
                    const imageUrl = publicUrlData.publicUrl;

                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ parent_category Ù…Ù† Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©)
                    let parentCategory = null;
                    if (category !== '__new__') {
                        const { data: existingProjects } = await supabase
                            .from('projects')
                            .select('parent_category')
                            .eq('category', category)
                            .limit(1);
                        
                        if (existingProjects && existingProjects.length > 0) {
                            parentCategory = existingProjects[0].parent_category;
                        }
                    }

                    // Insert project - Ù…Ø¹ Ø­Ù‚Ù„ category_en Ùˆ parent_category
                    const projectData = {
                        category: category,
                        category_en: categoryEn || category,
                        parent_category: parentCategory,
                        image_url: imageUrl,
                        show_on_homepage: showOnHomepage
                    };

                    const { error: insertError } = await supabase
                        .from('projects')
                        .insert([projectData]);

                    if (insertError) throw insertError;
                    
                    successCount++;
                    showStatus(`ØªÙ… Ø±ÙØ¹ ${successCount} Ù…Ù† ${images.length} ØµÙˆØ±Ø©...`, 'success');
                }

                showStatus(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${successCount} ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! âœ…`, 'success');
                document.getElementById('projectForm').reset();
                document.getElementById('selectedFiles').textContent = '';
                loadCategories();
                loadProjects();

            } catch (error) {
                console.error('Error:', error);
                showStatus('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });

        // Load Projects
        async function loadProjects() {
            try {
                const { data: projects, error } = await supabase
                    .from('projects')
                    .select('*')
                    .order('id', { ascending: false });

                if (error) throw error;

                allProjects = projects;
                renderProjects(projects);
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projectsTableBody').innerHTML = 
                    '<tr><td colspan="6" class="loading">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</td></tr>';
            }
        }

        // Render Projects
        function renderProjects(projects) {
            const tbody = document.getElementById('projectsTableBody');
            
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹</td></tr>';
                return;
            }

            tbody.innerHTML = projects.map(project => `
                <tr>
                    <td class="checkbox-cell">
                        <input type="checkbox" class="project-checkbox" value="${project.id}" 
                               onchange="updateBulkActions()">
                    </td>
                    <td>
                        <img src="${project.image_url}" alt="ØµÙˆØ±Ø© ${project.category}" class="project-image">
                    </td>
                    <td>${project.category}</td>
                    <td>
                        ${project.show_on_homepage !== false ? 
                            '<span class="badge badge-success">Ù…Ø¹Ø±ÙˆØ¶</span>' : 
                            '<span class="badge badge-danger">Ù…Ø®ÙÙŠ</span>'}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editProject(${project.id})">
                                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button class="action-btn toggle-btn" onclick="toggleHomepage(${project.id}, ${project.show_on_homepage !== false})">
                                <i class="fas fa-eye${project.show_on_homepage !== false ? '-slash' : ''}"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteProject(${project.id})">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Toggle Select All
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.project-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
            updateBulkActions();
        }

        // Update Bulk Actions
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            const count = checkboxes.length;
            
            document.getElementById('bulkDeleteBtn').disabled = count === 0;
            document.getElementById('bulkShowBtn').disabled = count === 0;
            document.getElementById('bulkHideBtn').disabled = count === 0;
        }

        // Edit Project
        async function editProject(id) {
            const project = allProjects.find(p => p.id === id);
            if (!project) return;

            const newName = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', project.name);
            if (!newName) return;

            const newCategory = prompt('Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', project.category);
            if (!newCategory) return;

            try {
                const { error } = await supabase
                    .from('projects')
                    .update({ name: newName, category: newCategory })
                    .eq('id', id);

                if (error) throw error;

                showStatus('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­! âœ…', 'success');
                loadCategories();
                loadProjects();
            } catch (error) {
                showStatus('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        // Toggle Homepage
        async function toggleHomepage(id, currentState) {
            try {
                const { error } = await supabase
                    .from('projects')
                    .update({ show_on_homepage: !currentState })
                    .eq('id', id);

                if (error) throw error;

                loadProjects();
            } catch (error) {
                showStatus('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        // Delete Project
        async function deleteProject(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ')) return;

            try {
                const project = allProjects.find(p => p.id === id);
                
                // Delete from database
                const { error } = await supabase
                    .from('projects')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                // Try to delete image from storage
                if (project.image_url) {
                    const path = project.image_url.split('/').pop();
                    await supabase.storage.from(BUCKET_NAME).remove([path]);
                }

                showStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­! âœ…', 'success');
                loadProjects();
            } catch (error) {
                showStatus('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        // Bulk Delete
        async function bulkDelete() {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${ids.length} Ù…Ø´Ø±ÙˆØ¹ØŸ`)) return;

            try {
                for (const id of ids) {
                    await deleteProject(id);
                }
                
                document.getElementById('selectAll').checked = false;
                updateBulkActions();
            } catch (error) {
                showStatus('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        // Bulk Toggle Homepage
        async function bulkToggleHomepage(show) {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

            try {
                const { error } = await supabase
                    .from('projects')
                    .update({ show_on_homepage: show })
                    .in('id', ids);

                if (error) throw error;

                showStatus(`ØªÙ… ØªØ­Ø¯ÙŠØ« ${ids.length} Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­! âœ…`, 'success');
                loadProjects();
                document.getElementById('selectAll').checked = false;
                updateBulkActions();
            } catch (error) {
                showStatus('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        // Show Status
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Categories Management Functions
        let categoriesData = [];

        function openCategoriesManager() {
            document.getElementById('categoriesModal').style.display = 'block';
            loadCategoriesForManager();
        }

        function closeCategoriesManager() {
            document.getElementById('categoriesModal').style.display = 'none';
        }

        async function loadCategoriesForManager() {
            try {
                const { data: projects } = await supabase
                    .from('projects')
                    .select('category, category_en, parent_category');

                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
                const categoriesMap = new Map();
                projects.forEach(p => {
                    const key = p.category;
                    if (!categoriesMap.has(key)) {
                        categoriesMap.set(key, {
                            ar: p.category,
                            en: p.category_en || p.category,
                            parent: p.parent_category || null
                        });
                    }
                });

                categoriesData = Array.from(categoriesMap.entries()).map(([key, value]) => ({
                    category: key,
                    category_en: value.en,
                    parent_category: value.parent
                }));

                renderCategoriesList();
                updateParentCategorySelect();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function updateParentCategorySelect() {
            const select = document.getElementById('parentCategorySelect');
            const mainCategories = categoriesData.filter(c => !c.parent_category);
            
            select.innerHTML = '<option value="">-- ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ Ø£Ø¨) --</option>';
            mainCategories.forEach(cat => {
                select.innerHTML += `<option value="${cat.category}">${cat.category} / ${cat.category_en}</option>`;
            });
        }

        function renderCategoriesList() {
            const container = document.getElementById('categoriesList');
            const mainCategories = categoriesData.filter(c => !c.parent_category);
            const subCategories = categoriesData.filter(c => c.parent_category);

            container.innerHTML = '';

            mainCategories.forEach(cat => {
                const catDiv = createCategoryItem(cat, false);
                container.appendChild(catDiv);

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©
                const subs = subCategories.filter(s => s.parent_category === cat.category);
                subs.forEach(sub => {
                    const subDiv = createCategoryItem(sub, true);
                    container.appendChild(subDiv);
                });
            });
        }

        function createCategoryItem(cat, isSub) {
            const div = document.createElement('div');
            div.className = isSub ? 'category-item sub-category' : 'category-item';
            
            div.innerHTML = `
                <div class="category-info">
                    <div class="category-name">${isSub ? 'â†³ ' : ''}${cat.category}</div>
                    <div class="category-name-en">${cat.category_en}</div>
                </div>
                <div class="category-actions">
                    <button class="btn" onclick="editCategory('${cat.category}')" style="background: #4CAF50;">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteCategory('${cat.category}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            return div;
        }

        async function addNewCategory() {
            const parentCat = document.getElementById('parentCategorySelect').value;
            const nameAr = document.getElementById('newCatNameAr').value.trim();
            const nameEn = document.getElementById('newCatNameEn').value.trim();

            if (!nameAr || !nameEn) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø¨ÙƒÙ„Ø§ Ø§Ù„Ù„ØºØªÙŠÙ†');
                return;
            }

            try {
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ ÙˆÙ‡Ù…ÙŠ Ø¨Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
                const dummyData = {
                    category: nameAr,
                    category_en: nameEn,
                    parent_category: parentCat || null,
                    image_url: 'https://via.placeholder.com/1',
                    show_on_homepage: false
                };

                const { error } = await supabase
                    .from('projects')
                    .insert([dummyData]);

                if (error) throw error;

                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('newCatNameAr').value = '';
                document.getElementById('newCatNameEn').value = '';
                document.getElementById('parentCategorySelect').value = '';

                loadCategoriesForManager();
                loadCategories(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                showStatus('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error adding category:', error);
                showStatus('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©', 'error');
            }
        }

        async function editCategory(categoryName) {
            const cat = categoriesData.find(c => c.category === categoryName);
            if (!cat) return;

            const newNameAr = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¹Ø±Ø¨ÙŠ):', cat.category);
            if (!newNameAr || newNameAr === cat.category) return;

            const newNameEn = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (English):', cat.category_en);
            if (!newNameEn) return;

            try {
                // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©
                const { error } = await supabase
                    .from('projects')
                    .update({ 
                        category: newNameAr,
                        category_en: newNameEn 
                    })
                    .eq('category', categoryName);

                if (error) throw error;

                loadCategoriesForManager();
                loadCategories();
                showStatus('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error editing category:', error);
                showStatus('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø©', 'error');
            }
        }

        async function deleteCategory(categoryName) {
            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© "${categoryName}" ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡Ø§ØŸ`)) return;

            try {
                const { error } = await supabase
                    .from('projects')
                    .delete()
                    .eq('category', categoryName);

                if (error) throw error;

                loadCategoriesForManager();
                loadCategories();
                loadProjects();
                showStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error deleting category:', error);
                showStatus('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©', 'error');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('categoriesModal');
            if (event.target == modal) {
                closeCategoriesManager();
            }
        }
    </script>
</body>
</html>
